# chapter 7

### 병렬 스트림

- 컬렉션에서 parallelstream() 호출

## 순차 스트림을 병렬 스트림으로

```java
Stream.iterate(1L, i -> i + 1)
.limit(n)
.parallel() <- 스트림을 병렬 스트림으로 변환
.reduce(0L, Long::sum); // 합을 반환
```

- parallel 호출하면 내부 병렬 수행 flag를 변화시킴.
- 반대로 sequential() 로 순차 스트림으로 변경 가능

- 기본형 특화 메서드 : LongStream.rangeClosed() → 박싱 문제 해결

- 병렬 스트림은 동시성 문제를 항상 동반함 → 공유 변수 사용 x, 순서의존 연산 x(findFirst 등)
- 자료구조의 특성을 파악 : ArrayList 가 LinkedList 보다 성능이 좋음
- 병합 비용 이슈 → 병합 비용이 크다면 비효율적일 수 있음

## 포크-조인 프레임워크

- 병렬화 작업을 재귀적으로 구현
- RecursiveTask<R> :  스레드 풀 사용을 위해 해당 클래스 구현, R : 병렬화 된 태스크가 생성하는 결과 형식 또는 결과가 없을 때 (결과가 없더라도 다른 비지역 구조를 바꿀 수 있다)는 RecursiveAction 형식
- 추상메서드 R compute() : 일반적으로 if-else의 구조로, 태스크 분할하거나 태스크를 계산하는 기능을 하도록 구현한다.
    
    ```java
    if (태스크가 충분히 작거나 더 이상 분할할 수 없으면) {
    	순차적으로 태스크 계산
    } else {
    	태스크를 두 서브태스크로 분할
    	태스크가 다시 서브태스크로 분할되도록 이 메서드를 재귀적으로 호출함
    	모든 서브태스크의 연산이 완료될 때까지 기다림
    	각 서브태스크의 결과를 합침
    }
    ```
    
    ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/e7c8143b-5f04-48af-a9a0-44271e9f4882/96c203e8-0293-447d-9e66-ba258739248f/Untitled.png)
    
- join 메서드를 태스크에 호출하면 태스크가 생산하는 결과가 준비될 때까지 호출자를 블록시킨다. 따라서 두 서브태스크가 모두 시작된 다음에 join을 호출해야 한다. 그렇지 않으면 각각의 서브태스크가 다른 태스크가 끝나길 기다리는 일이 발생하며 원래 순차 알고리즘보다 느리고 복잡한 프로그램이 되어버릴 수 있다.
- RecursiveTask 내에서는 Fork]oinPool의 invoke 메서드를 사용하지 말아야 한다. 대신 compute나 fork 메서드를 직접 호출할 수 있다. 순차 코드에서 병렬 계산을 시작할 때만 invoke 를 사용한다.
- 서브태스크에 fork 메서드를 호출해서 Fork]oinPool의 일정을 조절할 수 있다. 왼쪽 작업과 오른쪽 작업 모두에 fork 메서드를 호출하는 것이 자연스러울 것 같지만 한쪽 작업에는 fork를 호출하는 것보다는 compute를 호출하는 것이 효율적이다. 그러면 두 서브 태스크의 한 태스크에는 같은 스레드를 재사용할 수 있으므로 풀에서 불필요한 태스크를 할당하는 오버헤드를 피할 수 있다.
- 포크/조인 프레임워크를 이용하는 병렬 계산은 디버깅하기 어렵다. 보통 IDE로 디버깅할 때 스택 트레이스로 문제가 일어난 과정을 쉽게 확인할 수 있는데，포크/조인 프레임워크에서는 fork라 불리는 다른 스레드에서 compute를 호출하므로 스택 트레이스가 도움이 되지 않는다.

### 작업 훔치기

- 멀티코어를 활용한 병렬 프로그래밍은 항상 일정하게 실행되지 않는다. 순간적으로 디스크 접근 속도가 느려진다거나 외부 서비스와의 통신 과정에서도 지연이 발생할 수 있기 때문이다.
- 이를 work stealing 기법으로 해결한다.
- 병렬 프로그래밍에서 한 스레드가 다른 스레드보다 일찍 작업이 완료되었다면, 다른 스레드 큐에서 작업을 가져와 수행할 수 있다.
  ![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/e7c8143b-5f04-48af-a9a0-44271e9f4882/cc5528b1-de2e-4e18-976c-fb0f30dc6a17/Untitled.png)
  
